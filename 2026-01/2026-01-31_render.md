# Rails アプリを Render にデプロイ

## ローカルでの準備

  ```bash
  # config/master.key があるかどうかを確認（存在しない場合の例）
    $ ls config/master.key
    ls: config/master.key: No such file or directory

  # 既存の credentials.yml.enc が壊れている／作り直したい場合は削除
    $ rm config/credentials.yml.enc

  # 新しい credentials.yml.enc と master.key を作成する
    $ rails credentials:edit

  🤛 ココで credentials.yml.enc が開くが、変更せずに閉じる
  ```

  ### `credentials.yml.enc`ファイルと `master.key` について

  - `credentials.yml.enc` は、`master.key` で復号される
  - `master.key` は、Rails の秘密情報（DB パスワード、API キー等）を守るためのもの <br>🤛 *通常は`.gitignore` に含めてセキュリティを守り、GitHub には `credentials.yml.enc` だけを置く<br>（金庫`enc`は公開可、鍵`master.key`は絶対に非公開）*


  ### `rails credentials:edit` がやっていること

  ```bash
    $ rails credentials:edit
  ```

  - `master.key` を使って `credentials.yml.enc` を復号
  - 平文を **一時的にエディタで編集**
  - 保存時に必ず **再暗号化** される
  - 中身が空でも暗号文はそれなりの長さになる
  - 内容が同じなら Git 上では差分が出ない 🤛 *同じ平文内容であれば、再暗号化後の暗号文も同一になるため `git status` には上がらない*

---

## Render の設定

  🤛 *まだコミットしていないファイルがあれば、`git push` まで済ませてから以下を実行*

  ```
  # GitHub リポジトリと連携して Web アプリを公開する操作
    「+ New」
      ↓
    「Web Service」
      ↓
    デプロイするリポジトリを選択
      ↓
    「Connect」
      ↓
    必要な情報を記入 👇(下に詳細)
      ↓
    「Deploy Web Service」
  ```

  ### 「Add Environment Variable」の設定

  🤛 *`RAILS_MASTER_KEY` を環境変数で設定する*

  ```bash
  # 入力欄
    Key: `RAILS_MASTER_KEY`

  # 入力値
    Value: `master.key` の中身
  ```

  🤛 *入力値はローカルで確認*

  ```bash
    cat config/master.key

  # 表示された文字列をそのまま Render へ転記 (改行・空白・クォートは不要)
  ```

---

## Render について

- Render が発行する `*.onrender.com` は**公開 URL** <br>🤛 *認証なしで誰でもアクセス可能（ただしリンクされていないため検索エンジンには通常インデックスされない）*

- 無料枠では build 時に数分沈黙することもある <br>🤛 *`ERROR` や `Build failed` が出ていなければじっと待つ*

- 無料枠では一定時間後にアプリがスリープする（**コールドスタート**）<br>🤛 *最初のアクセス時は、Render 側のコンテナの起動に20〜30 秒程度かかる*

- 学習用途のデプロイは、経験自体が重要な学習となる <br>⚠️ *壊れても困らない前提で扱う* <br>⚠️ *本物の個人情報や秘密情報を入れない*

---

## 付箋メモ：PaaS / IaaS （またあらためて調べる）

### PaaS *(Platform as a Service)*
  🤛 例：Render

- サーバー・OS・実行環境はサービス側が用意
- アプリのコードだけをデプロイする
- 環境構築や運用を意識せずに公開できる
- 初学者や学習用途に向いている


### IaaS *（Infrastructure as a Service）*
  🤛 例：VPS / EC2

- OS だけが用意された状態のサーバー
- Ruby や DB など実行環境は自分で構築する
- 環境定義・運用も含めて責任を持つ
- 本番運用や自由度が必要な場合に使う


### 補足

- Docker は「環境をコードで再現する」ための道具
- `PaaS` でも `Dockerfile` を使えば環境定義を自分で持てる
