# アプリケーションの「テスト」について

## テストをめぐる開発手法

- **テスト駆動**（Test-Driven Development）:

  実装より**先にテストを書き**、そのテストを通す最小限のコードを実装する開発手法。「テスト→実装→リファクタリング」の短いサイクルを繰り返す。

  ### テスト駆動のサイクル

  1. `RED`: **失敗するテスト**を最初に書く
  2. `GREEN`: 次にアプリケーションのコードを書いて**成功させる**（パスさせる）
  3. `REFACTOR`: 必要なら**リファクタリング**する

- **一括テスト**:

  複数の機能や処理をまとめて、主に**開発の後半や完了時にまとめて実行するテスト**のやり方で、TDDと対比する文脈で使われる表現。
  不具合の原因箇所が特定しづらく、フィードバックが遅くなりがち。

### テストのメリット

1. 機能停止に陥るような**回帰バグを防止**できる。

    👉 *回帰バグ(Regression Bug): 以前のバグが再発したり機能の追加/変更に副作用が生じたりすること*

2. コードを**安全にリファクタリング**（機能を変更せずにコードを改善）できる。

3. アプリケーションの設計や、**他コンポーネントとのインターフェイスを先に明確化する**のに役に立つ。

    👉 *テストコードは、アプリケーションコードから見ればクライアントとして動作するので*

    📝 ただし、上記のメリットは**TDDでなくても得ることができる**。

### テストを書くのは「先」か「後」か？（ガイドライン）

- テストを「**先に**」書く
  - 本体のコードよりも明らかにテストコードの方が短くシンプル ➡️ テストを「先に」書く
  - セキュリティが重要な課題またはセキュリティ周りのエラーが発生した場合 ➡️ テストを「先に」書く
  - バグを見つけた ➡️ そのバグを再現するテストを「先に」書く

    👉 *回帰バグを防ぐ体制を整えてから修正に取りかかる*

  - リファクタリングするとき ➡️ 「先に」テストを書く

    👉 *エラーを起こしそうなコードや止まってしまいそうなコードを集中的にテストする*

- テストを「**後に**」書く
  - 動作の仕様がまだ固まりきっていない場合 ➡️ アプリケーションのコードを先に書き、期待する動作を「後で」書く
  - すぐにまた変更しそうなコード（HTML構造の細部など）に対するテスト ➡️ 「後で」書く

- テストを「**書かない**」（コストとリスクを比較した上での判断として）
  - 不安定な要素が特に見当たらないアプリケーションのコードを書くとき
  - ビューを中心に頻繁に改定される可能性の高いアプリケーションのコードを書くとき

    👉 *「書かない」と判断した場合でも、後からテストを追加できる余地は残しておく*

---

## テストコードの実行

### テストコードの例

```bash
# test/controllers/static_pages_controller_test.rb
require "test_helper"

class StaticPagesControllerTest < ActionDispatch::IntegrationTest

  test "should get home" do
    # 「アサーション」(assertion) と呼ばれる手法で動作を確認する
    get static_pages_home_url
    assert_response :success
  end
end
```

- ここに**TDD**で「新規ページ」を追加しようとするなら、
  1. まず `test` を追加する
  2. 次いで、ビューやルーティングなどを必要に応じて追加/修正する

#### テスト結果（例）

- **RED** （失敗）

  ```bash
  $ rails test
  NameError: undefined local variable or method `static_pages_about_url'
  3 runs, 2 assertions, 0 failures, 1 errors, 0 skips
  ```

  👉 *ココでは`NameError`が出ているので、エラーメッセージを頼りにコードを修正する*

- **GREEN** （成功）

  ```bash
  $ rails test
  3 runs, 3 assertions, 0 failures, 0 errors, 0 skips
  ```

- **REFACTOR**

  - 例として、**重複したコードを取り除く**などして改善を図る。

    📝 **DRY**（Don’t Repeat Yourself: 繰り返すべからず）

---

## テスト用の設定

### `minitest reporters` gem

  👉 *テスト結果の出力を見やすくフォーマットしてくれる gem*

#### 設定例

  ```bash
  # Gemfile
  group :test do
    …
    gem "minitest-reporters",       "1.6.0"
  end
  '''

  ```bash
  # test/test_helper.rb
  ENV["RAILS_ENV"] ||= "test"
  require_relative "../config/environment"
  require "rails/test_help"
  require "minitest/reporters" # ⬅️追記
  Minitest::Reporters.use! # ⬅️追記
  ```

  👉 *テスト結果に合わせて red や green の色付きの表示になる*

---

### `Guard` によるテストの自動化

  👉 *ファイルシステムの変更を監視し、例えば`static_pages_test.rb`ファイルなどを変更すると自動的にテストを実行してくれるツール*

#### 設定方法（例)

  ```bash
  # Gemfile
  group :test do
    …
    gem "guard",                    "2.18.0"
  end
  ```

  ```bash
  # ターミナルで初期化
  $ $ bundle exec guard init
  Writing new Guardfile to /home/ec2-user/environment/sample_app/Guardfile
  00:51:32 - INFO - minitest guard added to Guardfile, feel free to edit it
  ```

  ```bash
  # Guardfile をカスタマイズ
  ```

  👉 *`Guardfile`のコード例はコチラを参照: [railstutorial.org/guardfile](https://github.com/learnenough/rails_tutorial_sample_app_7th_ed/blob/main/Guardfile)*

  ```bash
  # 別ターミナルを開いて実行
  $ bundle exec guard
  ```

  👉 *`Guard`の終了は `Ctrl + D`*
